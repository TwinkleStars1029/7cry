<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="format-detection" content="telephone=no,email=no,address=no" />
<title>77嗚嗚-聊天模擬器</title>
<style>
  :root{
    --brand:#ff7f50; --ink:#2b2b2b; --muted:#6b7280;
    --page:#f0f2f5; --surface:#fff; --surface-hover:#f6f6f6;
    --panel:#fffaf7; --chip:#ffe8df; --border:#e6a892;
    --bubble-left:#ffe8df; --bubble-right:#f1f5f9;
    --header-grad-1:#ffd6c7; --header-grad-2:#ffd6c780;
    --avatar-bg:#e5e7eb; --avatar-npc-bg:#ffd5c7;
    --overlay:rgba(0,0,0,.12);
  }
  .theme-orange{ 
    --brand:#ff7f50; --chip:#ffe8df; --border:#e6a892;
    --panel:#fffaf7; --bubble-left:#ffe8df;--Sub-bg: #ff7f50;
    --header-grad-1:#fffbfa; --header-grad-2:#fce2db; --avatar-npc-bg:#ffd1e3;
  }
  .theme-blue  { 
    --brand:#3b82f6; --chip:#e6efff; --border:#a9c7ff;
    --panel:#f7fbff; --bubble-left:#e6efff;--Sub-bg: #3b82f6;
    --header-grad-1:#ecf2fc; --header-grad-2:#dbe9ff; --avatar-npc-bg:#e6efff;
  }
  .theme-green { 
    --brand:#22c55e; --chip:#e6ffe9; --border:#a6e8bb;
    --panel:#f2fff3; --bubble-left:#e6ffe9;--Sub-bg: #22c55e;
    --header-grad-1:#effcf4; --header-grad-2:#e2ffec; --avatar-npc-bg:#e6ffe9;
  }
  .theme-purple{ 
    --brand:#a855f7; --chip:#f3e8ff; --border:#d5b5ff;
    --panel:#faf5ff; --bubble-left:#f3e8ff;--Sub-bg: #a855f7;
    --header-grad-1:#f4edfa; --header-grad-2:#f1e2ff; --avatar-npc-bg:#f3e8ff;
  }
  .theme-pink{
    --brand:#ec4899; --chip:#fae9f1; --border:#FB2F7E;
    --panel:#fff7fb; --bubble-left:#ffe4f0;--Sub-bg: #FB2F7E;
    --header-grad-1:#FFF4F8; --header-grad-2:#ffe4ef; --avatar-npc-bg:#ffe4f0;
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--page);color:var(--ink);font:0.875rem/1.6 ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;display:grid;place-items:center;}
  /* Normalize iOS default blue button text */
  button, input, select, textarea{ color:inherit; font:inherit; -webkit-appearance:none; appearance:none; }
  .app{width:min(26.25rem,100vw);height:min(47.5rem,95vh);background:var(--panel);border:0.0625rem solid var(--border);box-shadow:0 0.625rem 1.875rem rgba(0,0,0,.08);overflow:hidden;position:relative;display:grid;grid-template-rows:auto auto 1fr auto;}
  .header{
  background:linear-gradient(180deg,var(--header-grad-1) 0%, var(--header-grad-2) 100%);
  padding:0;
  display:flex;
  align-items:center;      
  gap:0.5rem;
  border-bottom:0.0625rem solid var(--border);
}

/* 徽章靠左：移除 auto 推擠 */
.header{  background:var(--header-grad-1);
  padding:0.5rem 0.625rem;
  display:flex;
  align-items:center;
  gap:0.5rem;
  border-bottom:0.0625rem solid var(--border);
}


  /* Header */
  .header{  background:var(--header-grad-1);  padding:0.5rem 0.625rem; display:flex;  align-items:center;  border-bottom:0.0625rem solid var(--border);}

  /* 右邊整組 */
  .right-group{ margin-left:auto;  display:flex;  align-items:center;  gap:0.5rem; }
  .badge{ display:flex;  align-items:center;  gap:0.375rem;  background:var(--header-grad-2);    padding:0.25rem 0.625rem;  border-radius:62.4375rem;}
  .badge .status-icon{ width:1.125rem; height:1.125rem; display:grid; place-items:center; border-radius:50%;   font-size:0.75rem;}
  .mode-text{font-weight:700}
  .coins{ display:flex; align-items:center; gap:0.375rem; background:var(--header-grad-2); padding:0.25rem 0.625rem; border-radius:62.4375rem;}
  .coins .amount{color:#e63946;font-weight:800}
  .menu-btn{ width:1.875rem;height:1.875rem; border-radius:0.625rem; border:0 solid var(--border); background:var(--header-grad); display:grid;place-items:center; cursor:pointer;}
  .menu-btn span{font-size:1.125rem;line-height:1}


  /* Sub bar */
  .subbar{background:var(--Sub-bg);border-bottom:0.125rem solid var(--brand);padding:0.3125rem 0.3125rem;display:flex;align-items:center;gap:0.625rem;flex-wrap:wrap;color:#fff;}
  .tab{width:2.25rem;height:2.25rem;display:grid;place-items:center;background:#fff;color:var(--brand);clip-path: polygon(50% 12%, 85% 30%, 85% 70%, 50% 88%, 15% 70%, 15% 30%);font-weight:600;padding:0;border-radius:0}
  .pill{flex:1 1 ;height:1.75rem;border-radius:62.4375rem;border:0.0625rem solid var(--border);background:var(--surface);position:relative;display:grid;place-items:center;font-weight:700;color:var(--muted);}
  .pill .fill{position:absolute;left:0;top:0;bottom:0;width:50%;border-radius:62.4375rem;background:var(--chip);transition:width .25s ease;}
  .pill .label{position:relative;z-index:1;white-space:nowrap;display:inline-flex;gap:0.25rem}
  .stage-hint{padding:0.125rem;color:#fff;}
  .right-stat{margin-left:auto;color:#fff;padding:0.375rem 0.625rem;font-weight:600;white-space:nowrap;flex:0 0 auto}

  /* Chat */
  .chat{padding:0.75rem;overflow:auto;background:var(--surface)}
  .msg{display:grid;grid-template-columns:2.125rem 1fr;gap:0.5rem;margin:0.625rem 0;position:relative}
  .msg.right{grid-template-columns:1fr 2.125rem}
  .avatar{width:2.125rem;height:2.125rem;border-radius:50%;background:var(--avatar-bg);border:0.0625rem solid #d1d5db;display:grid;place-items:center;font-size:0.75rem;color:#9ca3af;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .avatar.npc{background:var(--avatar-npc-bg);border-color:#ffc3ae}
  .bubble{max-width:80%;padding:0.625rem 0.75rem;border-radius:0.875rem;border:0.0625rem solid #e5e7eb;background:var(--bubble-left);cursor:pointer;white-space:pre-line}
  .right .bubble{justify-self:end;background:var(--bubble-right)}

  /* Toolbar */
  .toolbar{background:var(--header-grad-1);border-top:0.0625rem solid #e5e7eb;padding:0.625rem;display:flex;gap:0.625rem;align-items:center}
  .input-wrap{position:relative;flex:1}
  .input{flex:1;width:100%;max-height:15rem;border-radius:0.75rem;border:0.0625rem solid #e5e7eb;padding:0.5rem 0.75rem;padding-right:2.75rem;resize:none;overflow-y:hidden;display:block}
  .fab{width:1.25rem;height:1.25rem;border-radius:50%;border:0.0625rem solid #e5e7eb;background:var(--Sub-bg);display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;font-size:0.875rem;line-height:1}
  .cta{position:absolute;right:0.5rem;top:50%;transform:translateY(-50%);width:1.75rem;height:1.75rem;border:none;background:transparent;color:var(--brand);display:grid;place-items:center;cursor:pointer;border-radius:0.375rem;}
  .sender-chip{padding:0.25rem 0.5rem;border:0.0625rem solid var(--border);border-radius:62.4375rem;background:var(--surface);color:#7a4b3a;white-space:nowrap}
  .sender-menu{position:absolute;bottom:4rem;left:0.625rem;background:var(--surface);border:0.0625rem solid #e5e7eb;border-radius:0.5rem;box-shadow:0 0.5rem 1.5rem rgba(0,0,0,.12);display:none;overflow:auto;max-height:13.75rem}
  .sender-menu.open{display:block;}
  .sender-menu button{display:flex;align-items:center;gap:0.5rem;width:11.25rem;padding:0.5rem 0.625rem;background:var(--surface);border:none;text-align:left;cursor:pointer}
  .sender-menu button img{width:1.25rem;height:1.25rem;border-radius:50%;object-fit:cover}
  .sender-menu button:hover{background:var(--surface-hover)}
  .sender-menu .check{margin-left:auto;color:var(--brand);font-weight:800;opacity:.0;transition:opacity .15s ease}
  .sender-menu button.is-active .check{opacity:1}

  /* 隱藏輸入框旁的發話者顯示（改為在清單打勾） */
  .sender-chip{display:none}

  /* Drawer */
  .drawer{position:absolute;top:0;right:0;bottom:0;width:min(23.75rem,92vw);background:var(--surface);border-left:0.0625rem solid var(--border);transform:translateX(100%);transition:transform .28s ease;z-index:20;display:flex;flex-direction:column}
  .drawer.open{transform:translateX(0)}
  .drawer header{padding:0.75rem;border-bottom:0.0625rem solid #eee;display:flex;align-items:center;justify-content:space-between;background:var(--surface)}
  .drawer .body{padding:0.75rem;overflow:auto;background:var(--panel)}
  .overlay{position:absolute;inset:0;background:var(--overlay);opacity:0;pointer-events:none;transition:opacity .28s ease;z-index:10}
  .overlay.show{opacity:1;pointer-events:auto}

  /* Drawer tabs */
  .tabs-head{display:flex;gap:0.5rem;margin-bottom:0.625rem}
  .tabs-head button{flex:1;padding:0.5rem 0.625rem;border:0.0625rem solid #ddd;background:var(--surface);border-radius:0.5rem;cursor:pointer}
  .tabs-head button.active{border-color:var(--brand);color:#fff;background:var(--brand)}
  .tabs-head button:not(.active){color:var(--ink)}
  .tab-panel{display:none}
  .tab-panel.active{display:block}

  /* form groups */
  .fg{display:grid;grid-template-columns:6.875rem 1fr;gap:0.5rem;align-items:center;margin:0.5rem 0}
  .fg label{font-weight:600}
  .fg input,.fg select{border:0.0625rem solid #d1d5db;border-radius:0.5rem;padding:0.5rem;width:100%}

  /* Roles editor */
  .role-card{display:grid;grid-template-columns:3rem 1fr;gap:0.625rem;align-items:center;background:var(--surface);border:0.0625rem solid #e5e7eb;border-radius:0.625rem;padding:0.5rem;margin:0.5rem 0}
  .role-card .avatar{width:3rem;height:3rem;border-radius:50%}
  .role-fields{display:grid;grid-template-columns:1fr;gap:0.5rem}
  /* Hide native file input and use custom trigger to avoid iOS blue text */
  .file-input{display:none}
  .file-trigger{padding:0.5rem 0.75rem;border-radius:0.5rem;border:0.0625rem solid #d1d5db;background:var(--surface);cursor:pointer;color:inherit;flex:1 1 auto;width:auto}
  .file-row{display:flex;gap:0.5rem;align-items:center}
  .role-actions{display:flex;gap:0.5rem;align-items:center;justify-content:center}
  .role-actions .btn{min-width:5.5rem}
  .btn.danger{background:#fee2e2;border-color:#fca5a5;color:#b91c1c;font-weight:700}
  .btn.danger:hover{background:#fecaca}
  .add-role{margin-top:0.5rem;width:100%;padding:0.5rem 0.75rem;border:0.0625rem dashed var(--brand);border-radius:0.625rem;background:var(--surface);cursor:pointer;font-weight:700}
  .limit-note{font-size:0.75rem;color:#666}

  /* ====== 氣泡選單與編輯對話框 ====== */
  .msg-menu{
    position:absolute;
    background:var(--surface);border:0.0625rem solid #e5e7eb;border-radius:0.5rem;
    box-shadow:0 0.5rem 1.5rem rgba(0,0,0,.15);
    z-index:30;display:none;overflow:hidden;
  }
  .msg-menu.open{display:block;}
  .msg-menu button{display:block;width:8.75rem;padding:0.625rem 0.75rem;border:none;background:var(--surface);text-align:left;cursor:pointer}
  .msg-menu button:hover{background:var(--surface-hover)}

  .dialog{
    position:absolute;inset:0;display:none;z-index:40;align-items:center;justify-content:center;
  }
  .dialog.show{display:flex;}
  .dialog .sheet{
    width:min(21.25rem,90vw);background:var(--surface);border:0.0625rem solid #ddd;border-radius:0.75rem;box-shadow:0 1.25rem 3.75rem rgba(0,0,0,.25);padding:0.75rem;display:grid;gap:0.5rem;
  }
  .dialog textarea{width:100%;min-height:6rem;padding:0.5rem;border:0.0625rem solid #d1d5db;border-radius:0.5rem;resize:vertical}
  .dialog .row{display:flex;gap:0.5rem;justify-content:flex-end}
  .btn{padding:0.375rem 0.75rem;border-radius:0.5rem;border:0.0625rem solid #ddd;background:var(--surface);cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}

  /* Ensure our custom buttons inherit text color */
  .menu-btn, .add-role, .tabs-head button, .msg-menu button, .btn{ color:inherit }
</style>
</head>
<body class="theme-pink">
  <main class="app" role="application" aria-label="地府求職模式">

    <!-- Header -->
    <header class="header">
      <div class="right-group">
        <div class="badge">
          <div class="status-icon" id="statusIcon">🙊</div>
          <div class="mode-text" id="modeText">無央保密模式</div>
        </div>
    
        <div class="coins">
          <span class="coin-icon" id="coinIcon">🥫</span>
          <span class="amount" id="coinAmount">999,999</span>
        </div>
    
        <button class="menu-btn" id="openDrawer" aria-label="開啟設定">⋮</button>
      </div>
    </header>

    <!-- Sub bar -->
    <section class="subbar">
      <div class="tab"><span class="tab-icon" id="tabIcon">♥</span></div>
      <div class="stage-hint" id="tabCurrent">遊魂</div>▶
      <div class="stage-hint" id="tabNext">打工仔</div>
      <div class="pill" aria-label="進度">
        <div class="fill" id="pillFill" style="width:50%"></div>
        <div class="label"><span id="progressPct">50%</span></div>
      </div>
      <div class="right-stat" id="rightStat">困惑度：50%</div>
    </section>

    <!-- Chat -->
    <section class="chat" id="chat" aria-label="對話">
      <article class="msg right">
        <div class="bubble">什麼年代了！還在用人工作業？生死簿不會還是用毛筆手寫的吧？</div>
        <div class="avatar">你</div>
      </article>
      <article class="msg">
        <div class="avatar npc">NPC</div>
        <div class="bubble">哇！妳怎麼知道？我們的毛筆還是用上等狼毫做的呢！</div>
      </article>
      <div style="height:1.5rem"></div>
    </section>

    <!-- Toolbar -->
    <footer class="toolbar">
      <button class="fab" id="senderBtn" aria-label="切換發話者">
        <span class="el-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
          </svg>
        </span>
      </button>
      <span class="sender-chip" id="senderChip">自己</span>
      <div class="input-wrap">
        <textarea class="input" id="msgInput" rows="1" placeholder="輸入訊息…"></textarea>
        <button class="cta" id="sendBtn" aria-label="送出訊息"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="m2 21l21-9L2 3v7l15 2l-15 2v7z"/></svg></button>
      </div>

      <!-- Sender menu -->
      <div class="sender-menu" id="senderMenu" role="menu" aria-label="選擇發話者"></div>
    </footer>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Drawer -->
    <aside class="drawer" id="drawer" aria-label="設定">
      <header>
        <strong>設定</strong>
        <button id="closeDrawer" class="menu-btn" aria-label="關閉設定"><span>X</span></button>
      </header>
      <div class="body">
        <!-- Tabs -->
        <div class="tabs-head">
          <button class="active" data-tab="uiTab">介面設定</button>
          <button data-tab="roleTab">角色設定</button>
        </div>

        <!-- UI settings -->
        <div class="tab-panel active" id="uiTab">
          <div class="fg"><label>對話模式</label><input id="inpMode" placeholder="無央保密模式" /></div>
          <div class="fg"><label>代幣ICON</label><input id="inpCoinIcon" placeholder="?? 或 emoji/字元" /></div>
          <div class="fg"><label>代幣數量</label><input id="inpCoinAmount" type="number" placeholder="999999" /></div>
          <div class="fg"><label>狀態ICON</label><input id="inpStatusIcon" placeholder="?? 或 emoji/字元" /></div>
          <div class="fg"><label>目前狀態</label><input id="inpCurrent" placeholder="遊魂" /></div>
          <div class="fg"><label>下階段狀態</label><input id="inpNext" placeholder="打工仔" /></div>
          <div class="fg"><label>進度名稱</label><input id="inpProgName" placeholder="打工" /></div>
          <div class="fg"><label>百分比</label><input id="inpPct" type="number" min="0" max="100" placeholder="50" /></div>
          <div class="fg">
            <label>色調</label>
            <select id="inpTheme">
              <option value="orange">橘色</option>
              <option value="blue">藍色</option>
              <option value="green">綠色</option>
              <option value="purple">紫色</option>
              <option value="pink" selected>粉色</option>
            </select>
          </div>
        </div>

        <!-- Role settings -->
        <div class="tab-panel" id="roleTab">
          <div class="limit-note">最多可新增 10 位角色。可上傳頭貼（建議 1:1）並設定名稱。</div>
          <div id="rolesWrap"></div>
          <button class="add-role" id="addRoleBtn">+ 新增角色</button>
        </div>
      </div>
    </aside>

    <!-- 氣泡選單 -->
    <div class="msg-menu" id="msgMenu" role="menu" aria-label="訊息操作">
      <button type="button" data-act="edit"> 編輯訊息</button>
      <button type="button" data-act="del"> 刪除</button>
    </div>

    <!-- 編輯對話框 -->
    <div class="dialog" id="editDialog" aria-modal="true" role="dialog">
      <div class="sheet">
        <strong>編輯訊息</strong>
        <textarea id="editTextarea" placeholder="輸入新內容…"></textarea>
        <div class="row">
          <button class="btn" id="editCancel">取消</button>
          <button class="btn primary" id="editSave">儲存</button>
        </div>
      </div>
    </div>

  </main>

<script>
  /* ===== Drawer open/close ===== */
  const drawer = document.getElementById('drawer');
  const overlay = document.getElementById('overlay');
  const openBtn = document.getElementById('openDrawer');
  const closeBtn = document.getElementById('closeDrawer');
  function openDrawer(){ drawer.classList.add('open'); overlay.classList.add('show'); }
  function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); }
  openBtn.addEventListener('click', openDrawer);
  closeBtn.addEventListener('click', closeDrawer);
  overlay.addEventListener('click', closeDrawer);

  /* ===== Tabs in drawer ===== */
  document.querySelectorAll('.tabs-head button').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tabs-head button').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById(b.dataset.tab).classList.add('active');
    });
  });

  /* ===== UI settings binding ===== */
  const elModeText = document.getElementById('modeText');
  const elCoinIcon = document.getElementById('coinIcon');
  const elCoinAmount = document.getElementById('coinAmount');
  const elStatusIcon = document.getElementById('statusIcon');
  const elTabIcon = document.getElementById('tabIcon');
  const elTabCurrent = document.getElementById('tabCurrent');
  const elTabNext = document.getElementById('tabNext');
  const elProgName = document.getElementById('progressName');
  const elProgPctText = document.getElementById('progressPct');
  const elPillFill = document.getElementById('pillFill');
  const elRightStat = document.getElementById('rightStat');

  const inpMode = document.getElementById('inpMode');
  const inpCoinIcon = document.getElementById('inpCoinIcon');
  const inpCoinAmount = document.getElementById('inpCoinAmount');
  const inpStatusIcon = document.getElementById('inpStatusIcon');
  const inpCurrent = document.getElementById('inpCurrent');
  const inpNext = document.getElementById('inpNext');
  const inpProgName = document.getElementById('inpProgName');
  const inpPct = document.getElementById('inpPct');
  const inpTheme = document.getElementById('inpTheme');

  function applyUI(){
    if (inpMode.value) elModeText.textContent = inpMode.value;
    if (inpCoinIcon.value) elCoinIcon.textContent = inpCoinIcon.value;
    if (inpCoinAmount.value !== '') elCoinAmount.textContent = Number(inpCoinAmount.value).toLocaleString();
    if (inpStatusIcon.value){ elStatusIcon.textContent = inpStatusIcon.value; elTabIcon.textContent = inpStatusIcon.value; }
    if (inpCurrent.value) elTabCurrent.textContent = inpCurrent.value;
    if (inpNext.value) elTabNext.textContent = inpNext.value;
    if (inpProgName.value) elProgName.textContent = inpProgName.value;

    // 百分比：若有輸入就更新，否則沿用目前顯示值
    let currentPct = elProgPctText.textContent;
    if (inpPct.value !== ''){
      const v = Math.max(0, Math.min(100, Number(inpPct.value)));
      currentPct = `${v}%`;
      elProgPctText.textContent = currentPct;
      elPillFill.style.width = `${v}%`;
    }

    // 右側統計：使用目前進度名稱與百分比
    const currentName = inpProgName.value || (elProgName ? elProgName.textContent : '困惑度');
    elRightStat.textContent = `${currentName}：${currentPct}`;

    document.body.className = `theme-${inpTheme.value}`;
  }
  [inpMode, inpCoinIcon, inpCoinAmount, inpStatusIcon, inpCurrent, inpNext, inpProgName, inpPct, inpTheme]
    .forEach(el => el.addEventListener('input', applyUI));
  applyUI();

  /* ===== Roles state & editor ===== */
  const MAX_ROLES = 10;
  const rolesWrap = document.getElementById('rolesWrap');
  const addRoleBtn = document.getElementById('addRoleBtn');
  let roles = [
    { id: crypto.randomUUID(), name: '自己', avatar: '', side: 'left' },
    { id: crypto.randomUUID(), name: 'NPC',  avatar: '', side: 'right' }
  ];
  let currentRoleId = roles[0].id;

  function renderRoles(){
    rolesWrap.innerHTML = '';
    roles.forEach(role=>{
      const card = document.createElement('div');
      card.className = 'role-card';

      const av = document.createElement('div');
      av.className = 'avatar';
      av.innerHTML = role.avatar ? `<img src="${role.avatar}" alt="${role.name}">` : role.name.slice(0,2);

      const fields = document.createElement('div');
      fields.className = 'role-fields';
      const nameInput = document.createElement('input');
      nameInput.value = role.name;
      nameInput.placeholder = '角色名稱';
      const fileInput = document.createElement('input');
      fileInput.type = 'file'; fileInput.accept = 'image/*'; fileInput.className = 'file-input';
      const fileBtn = document.createElement('button');
      fileBtn.type = 'button'; fileBtn.className = 'file-trigger'; fileBtn.textContent = '選擇頭貼';

      fields.appendChild(nameInput);
      fields.appendChild(fileBtn);
      fields.appendChild(fileInput);

      const actions = document.createElement('div');
      actions.className = 'role-actions';
      const del = document.createElement('button');
      del.textContent = '🗑 刪除'; del.className = 'btn danger';
      actions.appendChild(del);

      card.appendChild(av); card.appendChild(fields); card.appendChild(actions);
      rolesWrap.appendChild(card);

      nameInput.addEventListener('input', ()=>{
        role.name = nameInput.value || '未命名';
        av.textContent = '';
        if(role.avatar){ av.innerHTML = `<img src="${role.avatar}" alt="${role.name}">`; }
        else{ av.textContent = role.name.slice(0,2); }
        refreshSenderMenu();
      });

      fileBtn.addEventListener('click', ()=> fileInput.click());
      fileInput.addEventListener('change', ()=>{
        const f = fileInput.files[0];
        if(!f) return;
        // if(f.size > 2*1024*1024){ alert('圖片大小請小於 2MB'); fileInput.value=''; return; }
        const fr = new FileReader();
        fr.onload = e=>{
          role.avatar = e.target.result;
          av.innerHTML = `<img src="${role.avatar}" alt="${role.name}">`;
          fileBtn.textContent = '變更頭貼';
          refreshSenderMenu();
        };
        fr.readAsDataURL(f);
      });

      del.addEventListener('click', ()=>{
        if(roles.length <= 1){ alert('至少保留 1 位角色'); return; }
        roles = roles.filter(r=>r.id !== role.id);
        if(currentRoleId === role.id){ currentRoleId = roles[0].id; }
        renderRoles(); refreshSenderMenu();
      });
    });

    addRoleBtn.disabled = roles.length >= MAX_ROLES;
    addRoleBtn.textContent = roles.length >= MAX_ROLES ? '已達上限（10）' : '+ 新增角色';
  }
  addRoleBtn.addEventListener('click', ()=>{
    if(roles.length >= MAX_ROLES) return;
    roles.push({ id: crypto.randomUUID(), name: `角色${roles.length+1}`, avatar:'', side:'right' });
    renderRoles(); refreshSenderMenu();
  });
  renderRoles();

  /* ===== Sender menu ===== */
  const senderBtn = document.getElementById('senderBtn');
  const senderMenu = document.getElementById('senderMenu');
  const senderChip = document.getElementById('senderChip');

  function refreshSenderMenu(){
    senderMenu.innerHTML = '';
    roles.forEach(role=>{
      const btn = document.createElement('button');
      btn.type='button'; btn.dataset.id = role.id;
      btn.innerHTML = `${role.avatar ? `<img src="${role.avatar}" alt="">` : ''}<span>${role.name}</span><span class="check">✔</span>`;
      if(role.id === currentRoleId) btn.classList.add('is-active');
      btn.addEventListener('click', ()=>{
        currentRoleId = role.id;
        if(senderChip) senderChip.textContent = role.name;
        refreshSenderMenu();
        senderMenu.classList.remove('open');
      });
      senderMenu.appendChild(btn);
    });
    const current = roles.find(r=>r.id===currentRoleId) || roles[0];
    if(senderChip) senderChip.textContent = current.name;
  }
  refreshSenderMenu();
  senderBtn.addEventListener('click', (e)=>{ e.stopPropagation(); senderMenu.classList.toggle('open'); });
  document.addEventListener('click', ()=> senderMenu.classList.remove('open'));

  /* ===== Chat sending ===== */
  const chat = document.getElementById('chat');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');

  function autoResize(el){
    if(!el) return;
    el.style.height = 'auto';
    const cs = getComputedStyle(el);
    const maxH = parseInt(cs.maxHeight) || 160;
    const newH = Math.min(el.scrollHeight, maxH);
    el.style.height = (newH/16) + 'rem';
    el.style.overflowY = el.scrollHeight > maxH ? 'auto' : 'hidden';
  }

  // 初始化一次高度
  requestAnimationFrame(()=> autoResize(msgInput));

  function createMessage(text, role){
    const article = document.createElement('article');
    const isRight = role.name == '自己'; // 規則：名為「自己」靠左，其他靠右（可再加設定）
    article.className = 'msg' + (isRight ? ' right' : '');

    const avatar = document.createElement('div');
    avatar.className = 'avatar' + (isRight ? ' npc' : '');
    if(role.avatar){
      const img = document.createElement('img'); img.src = role.avatar; img.alt = role.name; avatar.appendChild(img);
    }else{
      avatar.textContent = role.name.slice(0,2);
    }

    const bubble = document.createElement('div');
    bubble.className = 'bubble'; bubble.textContent = text;

    if(isRight){ article.appendChild(bubble); article.appendChild(avatar); }
    else{ article.appendChild(avatar); article.appendChild(bubble); }
    return article;
  }

  function send(){
    const text = msgInput.value.trim();
    if(!text) return;
    const role = roles.find(r=>r.id===currentRoleId) || roles[0];
    const node = createMessage(text, role);
    const spacer = chat.lastElementChild;
    chat.insertBefore(node, spacer);
    msgInput.value = '';
    autoResize(msgInput);
    chat.scrollTop = chat.scrollHeight;
  }
  sendBtn.addEventListener('click', send);
  msgInput.addEventListener('input', ()=> autoResize(msgInput));
  msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});

  /* ======= Bubble: 編輯 / 刪除 ======= */
  const msgMenu = document.getElementById('msgMenu');
  const editDialog = document.getElementById('editDialog');
  const editTextarea = document.getElementById('editTextarea');
  const editCancel = document.getElementById('editCancel');
  const editSave = document.getElementById('editSave');

  let targetBubble = null;

  // 打開選單在點擊位置（限制在 app 邊界內）
  function openMsgMenu(x, y){
    const app = document.querySelector('.app').getBoundingClientRect();
    const menu = msgMenu.getBoundingClientRect();
    // 先顯示以取得尺寸
    msgMenu.classList.add('open');
    const w = msgMenu.offsetWidth || 160;
    const h = msgMenu.offsetHeight || 90;
    let left = x - app.left;
    let top  = y - app.top;
    if(left + w > app.width) left = app.width - w - 8;
    if(top  + h > app.height) top  = app.height - h - 8;
    if(left < 8) left = 8;
    if(top < 8) top = 8;
    msgMenu.style.left = (left/16) + 'rem';
    msgMenu.style.top  = (top/16)  + 'rem';
  }
  function closeMsgMenu(){ msgMenu.classList.remove('open'); }

  // 事件代理：點到 bubble 就彈選單
  chat.addEventListener('click', (e)=>{
    const b = e.target.closest('.bubble');
    if(!b) { closeMsgMenu(); return; }
    targetBubble = b;
    openMsgMenu(e.clientX, e.clientY);
    e.stopPropagation();
  });

  // 選單按鈕
  msgMenu.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const act = btn.dataset.act;
    if(act === 'edit'){
      closeMsgMenu();
      editTextarea.value = targetBubble ? targetBubble.textContent : '';
      editDialog.classList.add('show');
      editTextarea.focus();
    }else if(act === 'del'){
      const msg = targetBubble && targetBubble.parentElement;
      if(msg) msg.remove();
      closeMsgMenu();
    }
    e.stopPropagation();
  });

  // 關閉邏輯
  document.addEventListener('click', ()=>{ closeMsgMenu(); });
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){ closeMsgMenu(); editDialog.classList.remove('show'); }
  });

  // 編輯對話框
  editCancel.addEventListener('click', ()=> editDialog.classList.remove('show'));
  editSave.addEventListener('click', ()=>{
    const v = editTextarea.value.trim();
    if(targetBubble && v){ targetBubble.textContent = v; }
    editDialog.classList.remove('show');
  });
</script>
</body>
</html>

